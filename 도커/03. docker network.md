# docker network

## 도커 네트워크 구조
 - 도커 컨테이너에 내부 IP를 생성하며 이 IP는 순차적으로 할당됩니다. 단, 재시작하게 되면 변경될 수 있습니다.
 - 도커 컨테이너 내부 IP는 내부 망에서만 사용가능함으로 외부망와 연결될 필요가 있다.
 - 도커 각 컨테이너를 시작할 때마다 호스트에 veth...라는 네트워크 인터페이스를 생성하며 이를 통해 외부망와 연결이 가능해진다.
 - 외부와의 네트워크 연결을 제공하기 위해 컨테이너는 가상 네트워크 인터페이스를 호스트에 생성하며 veth로 시작합니다. 
 - 또한 컨테이너가 생성될때 자동으로 도커 엔진이 생성합니다.
 - ipconfig 명령어를 통해 조회하게 되면, eth0가 보일텐데 이는 공인IP 또는 내부IP가 할당되어 실제 와부와 통신이 가능한 호스트의 네트워크 인터페이스이다.
 - veth로 시작하는 인터페이스는 컨테이너를 시작할때 생성되며, 각 컨테이너의 eth0와 연결된다.
 - veth말고도 docker0이라는 브리지도 존재하며, 이는 컨테이너의 eth0 인터페이스와 호스트의 veth라는 인터페이스와 연결됐으며 veth 인터페이스는 docker0 브릿지와 바인딩돼 외부와 통신할 수 있습니다.

## 도커 네트워크 기능
- 컨테이너를 생성하면 기본적으로 docker0 브리지를 통해 외부와 통신할 수 있는데 선택에 따라 다른 네트워크 드라이버들을 사용할 수 있다.
- 도커에서 제공하는 대표적인 네트워크 드라이버로는 브리지(bridge), 호스트(host), 논(none), 컨테이너(container) 등이 있다. 서드파티 플러그인을 통해서 확장된 네트워크 구성도 사용할 수 있다.
- 명령어
    - [docker network ls] : 사용 가능한 네트워크 목록
        - 브리지 네트워크는 컨테이너를 생성할 때 자동으로 docker0와 연결되는 브리지를 활용하도록 설계되어 있다.
    - [docker network inspect] : 네트워크의 자세한 정보를 살펴볼 수 있다.

## 네트워크 종류
 - 브리지, 호스트, 논, 컨테이너에 대한 설명

### 브리지 네트워크
- 브리지 네트워크는 docker0와 비슷하게 사용자 정의 브리지를 새로 생성해 각 컨테이너에 연결하는 네트워크 구조이다.(기본 bridge는 docker0와 연결되어 있다.)
- 명령어
    - [docker network create --driver [타입] [이름]] : [타입]의 새로운 네트워크가 생성된다.
        - 서브넷, 게이트웨이, ip 등 임의 설정 하려면 아래와 같은 옵션을 추가한다.
            - [--subnet] 
            - [--ip-range]
            - [--gateway]
    - [docker -run ... --net [이름]] : 도커 컨테이너 시작시 정의된 새로운 네트워크 연결
    - [docker network connect/disconnect [네트워크이름] [컨테이너이름]] : 유동적으로 [타입] 네트워크를 끊거나 연결할 수 있다.
        - 해당 명령어는 특정 IP대역을 갖는 네트워크 모드에서만 사용이 가능하다.
    
### 호스트 네트워크
- 호스트의 네트워크 환경을 그대로 쓸 수 있습니다. 브리지 드라이버 네트워크와 달리 호스트 드라이버의 네트워크는 별도로 생성할 필요 없이 host라는 기존 이름의 네트워크를 사용합니다.
    - [--net host]
- 컨테이너의 네트워크를 호스트 모드로 설정하면 컨테이너 내부의 애플리케이션을 별도의 포트 포워딩 없이 바로 서비스 할 수 있다.

### 논 네트워크
- 말그대로 아무런 네트워크를 쓰지 않는 것, 외부와의 단절된 네트워크 상태
    - [--net none]

### 컨테이너 네트워크
- 다른 컨테이너의 네트워크 네임스페이스 환경을 공유한다.
    - [--net container:[다른 컨테이너 ID]]
- 공유되는 속성은 내부 IP, 네트워크 인터페이스의 맥(mac) 주소 등
- 해당 컨테이너 네트워크를 사용하면 내부 IP를 새로 받지 않고 호스트에도 veth로 시작하는 가상 네트워크 인터페이스도 생성되지 않습니다.(진짜 하나를 공유해서 쓰는것 같다.)

## 브리지 네트워크와 [--net-alias]
- 브리지 타입의 네트워크와 run 명령어의 --net-alias 옵션을 함께 쓰면 특정 호스트 이름으로 컨테이너 여러개에 접근할 수 있습니다.
    - ping 명령어를 통해서 확인해보면 컨테이너 3개의 ip로 각각 전송이 됨(ip가 바뀌더라도 똑같이 확인이 가능함)
- 위와 같이 ip가 변경되더라도 컨테이너의 별명을 통해서 도커의 DNS에 의해 자동으로 관리된다.
- 사용자가 정의한 브리지 네트워크도 내장 DNS서버를 가지며 DNS서버에 [--net-alias] 옵션을 입력한 값이 호스트 이름으로 등록이 된다.
- 등록된 호스트 이름으로 접근하게 되면 DNS 서버는 라운드 로빈을 이용해 컨테이너 ip 리스트를 반환하고 ping명령어는 이 ip 리스트에서 첫번쨰 ip를 사용함으로 매번 다른 ip로 핑을 전송한다.

## MacVLAN 네트워크 
- 호스트의 네트워크 인터페이스 카드를 가상화해 물리 네트워크 환경을 컨테이너에게 동일하게 제공하는 방법
- MacVLAN을 사용하면 컨테이너는 물리 네트워크 상에서 가상의 맥(MAC)주소를 가지게 되며, 이를 이용하여 해당 네트워크에 연결된 다른 장치와 통신이 가능해진다.
    - 연결된 컨테이너는 기본적으로 네트워크 장비의 ip를 할당받기 때문에 가능함.
    - 단, 서버1에서 사용되는 컨테이너는 서버1와는 통신이 불가능하고 서버2(다른)와는 통신이 가능하다.
- 명령어
    [docker network create -d macvlan --subnet=[주소] --ip-range=[주소] --gateway=[주소] -o maclan_mode=bridge -o parent=eth0 [이름]]
        - [-d] : 네트워크 드라이버로 macvlan을 사용([--driver] 동일)
        - [--subnet] : 컨테이너가 사용할 네트워크 정보(장비 설정)
        - [--ip-range] : 호스트에서 사용할 컨테이너의 ip 범위, 반드시 겹치지 않게 설정
        - [--gateway] : 네트워크에 설정된 게이트웨이 입력(장비 설정)
        - [-o] : 네트워크 추가적인 옵션 설정
            - [-o macvlan_mode=bridge] : 네트워크 모드 브릿지 설정
            - [-o parent=eth0] : 컨테이너의 네트워크 인터페이스의 부모인터페이스 설정

## VLAN
- 설명
    - VLAN(Virtual Local Area Network) 물리적 배치와 상관없이 논리적으로 LAN 구성하는 기술
    - VLAN은 물리적 네트워크 구성이 아닌 논리적 네트워크 구성이다.
        - 물리적 네트워크 : 스위치가 다른 각각의 컴퓨터들이 있다고 가정하자, 이 두 컴퓨터는 물리적으로 서로 떨어져 있으며 서로 통신할 방법이 없다. (독립적으로 네트워크 구성)
        - 논리적 네트워크 : 하나의 스위치에 포트가 1~10이 있다고 가정하자, 1~5 VLAN1, 6~10 VLAN2로 설정했다면 물리적으로 같은 스위치에 있어도 VLAN1와 VLAN2는 서로 통신할 방법이 없다.
    - 위 논리적 네트워크처럼 하나의 스위치에 여러개의 인터페이스를 하나의 브로드캐스트 도메인으로 구성하고, 다른 인터페이스들을 다른 브로드캐스트로 구성하여 여러개 도메인을 만들 수 있는데, 이렇게 하나의 스위치에 논리적으로 만들어진 브로드캐스트 도메인을 VLAN이라고 한다.
- 장점 
    - 네트워크 리소스 보안을 높인다.
    - 비용을 절감할 수 있다.(차단된 LAN환경 구축시 추가장비가 필요 없다.)
    - 관리자의 네트워크 설정작업에 용이하다.(장비 안옮기고 스위치 설정만으로도 가능)
    - 불필요한 트래픽을 줄인다.(VLAN은 서로 다른 네트워크 그룹이기에 브로드캐스트 패킷이 다른 VLAN 전송이 가지 않는다.)
- VLAN 설명 좋은 사이트 : https://onecellboy.tistory.com/278 (여기가 가장 잘이해되는..)

## MacVLAN
- VLAN의 종류 중 하나
- 모든 장비에는 고유의 MAC Adress를 가지는데, 이 MAC Adress를 이용하여 VLAN을 구성하는 방식
- MAC Adress는 고유하기에 어떤 포트에 연결되던 동일한 VLAN 구성을 갖는다. 
- 단점으로는 각 장비별 MAC Adress를 알고 있어야 한다. 또한 NIC 추가 교환하는 상황에서 VLAN를 다시 구성해야하는 점도 있다.