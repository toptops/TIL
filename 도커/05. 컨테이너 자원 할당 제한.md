# 컨테이너 자원 할당 제한

## 컨테이너 자원 할당
- 컨테이너를 생성하는 run, create 명령어에서 컨테이너의 자원 할당량을 조정하도록 옵션을 입력할 수 있습니다.
- 아무런 옵션을 입력하지 않는다면 기본설정으로 컨테이너는 호스트의 자원을 제한 없이 쓸수 있으므로 제품단계의 컨테이너는 자원 할당을 제한해 호스트와 다른 컨테이너의 동작을 방해하지 않게 설정하는 것이 좋습니다.
- 자원 할당 옵션을 설정하지 않는다면 만약 어떤 컨테이너가 호스트 자원을 모두 점유해 버린다면 다른 컨테이너가 아니라 호스트 자체가 동작이 멈출 수 있습니다.
- 도커에서 [inspect] 명령어를 통해서 현재 컨테이너에 설정된 자원 제한을 확인할 수 있습니다.
- [docker inspect (NAME | ID)] : 자원에 대한 상세정보를 확인할 수 있습니다.

## 컨테이너 자원 제한
1. 컨테이너 메모리 제한
    - docker run 명령어에 [--memory]를 지정해 컨테이너의 메모리를 제한할 수 있습니다.
    - 입력할 수 있는 단위는 m(megabyte), g(gigabyte)이며 제한할 수 있는 최소 메모리는 4MB입니다.
    - 또한 메모리를 제한하게 되면 컨테이너에 설정된 메모리를 초과하여 사용하게 되면 해당 컨테이너는 자동으로 종료됨으로 메모리를 적절하게 할당해야 합니다.
    - [docker --memory="n(단위)"] 
        - 예) docker run -i -d --name memory_4m --memory="4m" mysql:5.7
2. 컨테이너 CPU 제한
    - [--cpu-shares]
        - [--cpu-shares] 옵션은 컨테이너에 가중치를 설정해 해당 컨테이너가 CPU를 상대적으로 얼마나 사용할 수 있는지를 나타냅니다.
        - 즉, 컨테이너에 CPU를 한 개식 할당하는 방법이 아닌, 시스템에 존재하는 CPU를 설정한 비중만큼 나눠쓸 것인지를 명시하는 옵션입니다. 또한 상대적인 값을 가지므로 하나일 경우에는 100퍼센트 차지하지만 하나 이상일 경우부터 비중만큼 나눠서 사용됩니다.
        - 예) --cpu-shares 옵션으로 1024와 512를 가지는 두개의 컨테이너에 CPU 1에 스트레스 테스트를 하여 CPU를 어떻게 할당하는지 확인하자
            - docker run -d --name cpu 1024 --cpu-shares 1024 ... stress --cpu 1
            - docker run -d --name cpu 1024 --cpu-shares 512 ... stress --cpu 1
            - ps aus | grep stress 명령어를 사용하여 확인해보면 1024 : 512 비율 즉, 2:1의 비율로 CPU를 1024는 69%, 512는 33%를 각각 점유하고 있다.
    - [--cpuset-cpu]
        - [--cpuset-cpu] 옵션은 호스트에 CPU가 여러개 있을 경우 컨테이너가 특정 CPU만 사용하도록 지정할 수 있다.
        - CPU 집중적인 작업이 필요하다면 여러개의 CPU를 사용하도록 설정해 작업을 적절히 분배하는것이 좋다.
        - 예) 컨테이너가 3번째 CPU만 사용하도록 설정
            - docker run -d --name cputest_2 --cpuset-cpus=2 ... stress --cpu 1
        - htop 명령어로 CPU 사용량을 확인하면 3번째 CPU만 사용되는 것을 알 수 있다.
    - [--cpu-period, --cpu-quota]
        - 먼저 CFS 스케쥴러를 알아보자
            - 실행 대기 상태인 프로세스들을 우선 순위에 따라 공정하게 실행하는 스케쥴러, 프로스마다 타임 슬라이스라는 단위 시간을 부여하는데 이는 프로세스가 CPU에서 실행할수 있는 시간이다.
            - 타임 슬라이스를 다소진하게 되면 선점 스케쥴링 대상이라고 마킹하고 컨택스트 스위칭 된다.
            - 우선순 순위에 따라 높은 순위 프로세스를 컨텍스트 스위칭하는데 이때 순위에 따라 가장 먼저 실행시키고 더 많은 타임 슬라이스를 할당해준다.
        - 컨테이너 CFS 주기는 기본적으로 100ms로 설정되지만 run명령어의 옵션 중 [--cpu-period & --cpu-quota]로 주기를 변경할 수 있다.
        - 예) docker run -d --name quota_1_4 --cpu-period=100000 --cpu-quota=25000 ... stress --cpu 1
            - [--cpu-period]의 기본 설정 값은 100000이며 이는 100ms를 의미한다. [--cpu-quota]는 [--cpu-period]에 설정된 시간 중 CPU 스케쥴링이 얼마나 할당할 것인지를 설정한다.
            - 위 예시에서느 100000(--cpu-period) 중 25000(--cpu-quota)만큼을 할당해 CPU 주기가 1/4로 줄었으므로 CPU성능이 1/4정도로 감소한다.
            - 즉, 컨테이너는 [--cpu-quota]/[--cpu-period]만큼의 CPU시간을 할당 받는다.
    - [--cpus]
        - [--cpus] 옵션은 위 period/quota와 동일한 기능을 하지만 좀 더 직관적으로 CPU의 개수를 직접 지정한다는 점에서 조금 다르다.
        - 예) [--cpus=0.5] = [--cpu-quota=50000]/[--cpu-period=100000]
    - 컨테이너에서 CPU옵션 중 [--cpuset-cpu]옵션을 사용하는게 좋다. 해당 옵션을 사용하면 특정 컨테이너가 특정 CPU에서만 작동하기에 CPU 친화성을 보장하고 CPU 캐시미싱 혹은 컨텍스트 스위칭 같은 성능 하락의 요인을 최소화 할 수 있다.
3. Block I/O 제한
    - 컨테이너를 생성할 때 아무런 옵션도 설정하지 않으면 컨테이너 내부에서 파일을 읽고 쓰는 대역폭에 제한이 설정되지 않으므로 과도하게 사용될 수 있다.
    - 단, Direct I/O의 경우에만 블록 입출력이 제한되며 Buffered I/O에는 제한되지 않는다.
        - Direct I/O : 버퍼를 거치지 않고 직접 IO를 수행
        - Bufferd I/O : 위 Direct I/O와는 반대로 일반적인 I/O(버퍼를 거침)
    - [--device-write-bps], [--device-read-bps] : 각 쓰고 읽는 작업의 초당 제한을 설정할 수 있으며 단위로는 kb, mb, gb단위로 제한할 수 있다.
        - 예) docker run -it --device-write-bps /dev/xvda:1mb ubuntu:14.04
    - [--device-write-iops], [--device-read-iops] : [--cpu-shares] 처럼 상대적인 값을 입력했던 것 처럼 상대적인 값을 이용해 설정한다.

    
