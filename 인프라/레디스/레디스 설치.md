# 레디스 설치

## 레디스 구성
1. 레디스 센티널 구성
2. 레디스 모니터링(그라파나)
3. 레디스 클러스터 구성(시간남으면)

## 레디스 센티널 구성
- 레디스 센티널 구성은 총 3개의 센티널로 구성되며, 2개의 센티널 서버에만 저장소를 설치하고 1개의 서버에는 센티널만 가용한다.

## 레디스 모니터링
- 그라파나 + 프로메테우스 이용(기본 메트릭만 이용하겠음)
    - 프로메테우스를 이용하려고 하지 않았지만.. 내가 메트릭을 따로 구성해야되니 귀찬았다. 차라리 프로메테우스에서 제공되는 기능을 이용하고 관리 포인트를 늘리는게 더 현명한것 같다.

## 전체적인 구성
- 레디스 서버1(마스터 + 센티널 + 프로메테우스)
- 레디스 서버2(슬레이브 + 센티널 + 프로메테우스)
- 레디스 서버3(센티널)
- 그라파나

총 4가지를 구성하여 고가용성 유지, 센티널의 단점은 중간에 네트워크 단절이 일어나게 되면 데이터 유실됨(ㅅㅂ)2023

## 레디스 센티널 구성 버그
- 레디스 센티널 구성 중 버그가 발생했다(아주 죽이고 싶다)
- 도커를 통해서 구성을 했다.
    - 레디스 서버 구축3 마스터1, 슬레이브1, 슬레이브2 
    - 레디스 센티널 구축3 서버1, 서버2, 서버3 
- 버그는 failover에서 발생하였다. 처음 동작후 마스터를 죽이고 무사히 슬레이브가 마스터로 승격된 이후 마스터를 재시동 하면 몇 초후 슬레이브 정보가 복제가 되는 문제가 발생함(????)
- info sentinel로 처음 찍어보면 슬레이브는 2인데 이후 슬레이브는 3이되어 있음, 이유는 마스터 정보가 갑자기 name이 변경되고 flag disconnetced상태가 되어 있음.
- 다시 마스터를 시동하면 새로운 slave 정보와 기존 쓰레기 정보가 같이 공존함(?) 
- 근데 failover 테스트를 한번 하고나면 잘동작함(?) 이무슨 개소린가 싶지만 이 이상은 나도 잘모르곘다.

## 그라파나 연동(센티널)
- 레디스 + 센티널 연동, 클러스터가 아니다 보니 기본연동에서도 에러가 뜨네...
- 센티널을 클러스터로 바꾸고 데이터 소스를 프로메테우스로 변경하여 진행해보겠다.
- 추가로 그라파나 연동은 성공적으로 되었기에 여기에 프로메테우스까지 연동하여 기본 잘된 대시보드를 긁어오겠다.

## 레디스 클러스터링 + 프로메테우스 + 그라파나
- 아오.. 프로메테우스랑 연동하려니 node,redis exporter를 설치해야하는데.. 결국 직접 Dockerfile을 작성해야 했다 ㅠㅠ
- 이건 잠정적으로 후순위로 미뤄야겠다.